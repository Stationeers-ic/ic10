<!doctype html>
<html lang="ru">

<head>
	<meta charset="UTF-8" />
	<meta content="width=device-width, initial-scale=1" name="viewport" />
	<title>ic10 runner</title>
	<script src="/dist/ic10.umd.js"></script>
	<style>
		body {
			font-family:
				system-ui,
				-apple-system,
				Segoe UI,
				Roboto,
				Arial,
				sans-serif;
			margin: 16px;
		}

		.row {
			display: flex;
			gap: 12px;
			align-items: center;
			margin-bottom: 8px;
		}

		textarea {
			width: 100%;
			height: 160px;
			font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
			font-size: 14px;
		}

		button {
			padding: 8px 12px;
			font-size: 14px;
		}

		#console {
			border: 1px solid #ddd;
			background: #0b0f14;
			color: #e6eef8;
			padding: 10px;
			height: 320px;
			overflow: auto;
			border-radius: 6px;
		}

		#console .line {
			white-space: pre-wrap;
			word-break: break-word;
			margin: 2px 0;
		}

		#console .log {
			color: #e6eef8;
		}

		#console .warn {
			color: #ffcc66;
		}

		#console .error {
			color: #ff6b6b;
		}

		#console table {
			border-collapse: collapse;
			margin: 4px 0;
		}

		#console th,
		#console td {
			border: 1px solid #3a3f45;
			padding: 2px 6px;
			font-size: 12px;
		}

		#console th {
			background: #19212a;
		}
	</style>
</head>

<body>
	<h1>ic10 Runner</h1>

	<div class="row">
		<button id="runBtn">Запустить</button>
		<span id="status" aria-live="polite"></span>
	</div>

	<textarea id="code" spellcheck="false">
s db Mode 1
s db Setting STR("TEST")</textarea>

	<h3>Консоль</h3>
	<div id="console" role="log" aria-live="polite"></div>

	<script>
		// Вывод в блок "Консоль"
		(function setupUiConsole() {
			const el = document.getElementById('console');
			const native = {
				log: console.log.bind(console),
				warn: console.warn.bind(console),
				error: console.error.bind(console),
				table: console.table ? console.table.bind(console) : null,
			};

			function renderValue(v) {
				const span = document.createElement('span');
				try {
					if (typeof v === 'string') {
						span.textContent = v;
					} else if (v instanceof Error) {
						span.textContent = v.stack || v.message || String(v);
					} else if (typeof v === 'object') {
						span.textContent = JSON.stringify(v, null, 2);
					} else {
						span.textContent = String(v);
					}
				} catch {
					span.textContent = String(v);
				}
				return span;
			}

			function appendLine(type, args) {
				const line = document.createElement('div');
				line.className = 'line ' + type;
				for (let i = 0; i < args.length; i++) {
					if (i > 0) line.appendChild(document.createTextNode(' '));
					line.appendChild(renderValue(args[i]));
				}
				el.appendChild(line);
				el.scrollTop = el.scrollHeight;
			}

			function appendTable(data, columns) {
				try {
					const table = document.createElement('table');
					const thead = document.createElement('thead');
					const tbody = document.createElement('tbody');

					let rows = [];
					let headers = [];

					if (Array.isArray(data)) {
						rows = data;
						if (rows.length) {
							headers = columns && columns.length ? columns : Object.keys(rows[0]);
						}
					} else if (typeof data === 'object' && data) {
						headers = ['(index)', 'value'];
						rows = Object.keys(data).map((k) => ({ '(index)': k, value: data[k] }));
					} else {
						appendLine('log', [data]);
						return;
					}

					const trh = document.createElement('tr');
					headers.forEach((h) => {
						const th = document.createElement('th');
						th.textContent = String(h);
						trh.appendChild(th);
					});
					thead.appendChild(trh);

					rows.forEach((r) => {
						const tr = document.createElement('tr');
						headers.forEach((h) => {
							const td = document.createElement('td');
							const v = r[h];
							td.textContent = typeof v === 'object' ? JSON.stringify(v) : String(v);
							tr.appendChild(td);
						});
						tbody.appendChild(tr);
					});

					table.appendChild(thead);
					table.appendChild(tbody);

					const container = document.createElement('div');
					container.className = 'line log';
					container.appendChild(table);
					el.appendChild(container);
					el.scrollTop = el.scrollHeight;
				} catch (err) {
					appendLine('error', ['Ошибка вывода таблицы:', err]);
				}
			}

			console.log = (...args) => {
				appendLine('log', args);
				native.log(...args);
			};
			console.warn = (...args) => {
				appendLine('warn', args);
				native.warn(...args);
			};
			console.error = (...args) => {
				appendLine('error', args);
				native.error(...args);
			};
			console.table = (data, columns) => {
				appendTable(data, columns);
				native.table && native.table(data, columns);
			};

			window.clearUiConsole = function () {
				el.textContent = '';
			};
		})();


		ic10.i18n.init().then((lang) => {
			lang.setLanguage('ru');
			const statusEl = document.getElementById('status');
			const runBtn = document.getElementById('runBtn');
			const codeEl = document.getElementById('code');

			function setStatus(text) {
				statusEl.textContent = text || '';
			}
			function ensureIc10() {
				if (!window.ic10) throw new Error('ic10 не загружен. Проверьте путь к /dist/ic10.umd.js');
			}

			// ==== Реализация createRunner и утилит на базе глобального ic10 ====

			function createRunner(ic10Code, options) {
				options = options || {};
				const network = options.network || new ic10.Network();
				const chip = new ic10.Chip({
					ic10Code,
					register_length: options.register_length != null ? options.register_length : 16,
					stack_length: options.stack_length != null ? options.stack_length : 512,
				});
				const socket = new ic10.StructureCircuitHousing({
					network,
					chip,
				});
				return new ic10.Ic10Runner({ housing: socket });
			}

			async function runInstructionTest(runner, testData) {
				await runner.run(); // песочница
				runner.switchContext('real');
				if (testData.iterations_count) {
					for (let i = 0; i < testData.iterations_count; i++) {
						await runner.step();
					}
				} else {
					await runner.run();
				}
				return runner;
			}

			async function runDualContext(runner) {
				await runner.run(); // песочница
				await runner.switchContext().run(); // рабочая среда
				return runner;
			}

			function resolveExpectation(runner, exp) {
				switch (exp.type) {
					case 'register': {
						const got = runner.realContext.chip.registers.get(exp.register);
						return { label: `r${exp.register}`, expected: exp.value, got };
					}
					case 'device': {
						const got = runner.realContext.getDeviceParameterByPin(exp.pin, exp.prop);
						return { label: `pin ${exp.pin}.${String(exp.prop)}`, expected: exp.value, got };
					}
					case 'loop': {
						const got = runner.realContext.getNextLineIndex();
						return { label: 'nextLineIndex', expected: exp.nextLineIndex, got };
					}
				}
			}

			function logExpectation(runner, exp) {
				const { label, expected, got } = resolveExpectation(runner, exp);
				console.log(`exp ${label} = ${expected} | got ${got}`);
			}

			function expectExpectation(runner, exp, expectImpl) {
				const { expected, got } = resolveExpectation(runner, exp);
				expectImpl(got).toBe(expected);
			}

			function expectAll(runner, expectedList, expectImpl) {
				for (const exp of expectedList) {
					expectExpectation(runner, exp, expectImpl);
				}
			}

			function logAll(runner, expectedList) {
				for (const exp of expectedList) {
					logExpectation(runner, exp);
				}
			}

			// ==== Кнопка "Запустить" ====

			async function run() {
				clearUiConsole();
				setStatus('Выполнение...');
				runBtn.disabled = true;

				try {
					ensureIc10();

					const code = codeEl.value;
					const runner = createRunner(code, { register_length: 16, stack_length: 512, hash: 125 });

					console.log('Запуск в песочнице');
					// Если у Ic10Runner есть init(), можно вызвать безопасно
					if (typeof runner.init === 'function') {
						await runner.init().run();
					} else {
						await runner.run();
					}

					runner.context.errors.map((error) => {
						console.error(error.formated_message);
					});

					const strongErrors = runner.context.errors.filter(
						(error) => error.severity === ic10.ErrorSeverity.Strong,
					);
					if (strongErrors.length === 0) {
						console.log('Запуск в рабочей среде');
						await runner.switchContext().run();
						runner.context.errors.map((error) => {
							console.error(error.formated_message);
						});
					}

					// Registers
					console.table(runner.realContext.chip.registers);

					// Housing properties
					const props = (runner.realContext.housing && runner.realContext.housing.properties) || {};
					const keys = Reflect.ownKeys(props);
					const table = keys.map((key) => ({
						property: String(key),
						value: props[key],
					}));
					console.table(table);

					// Context switcher errors
					const switcherErrors = runner.contextSwitcher?.getErrors?.() || [];
					switcherErrors.forEach((e) => console.log(e.formated_message));
				} catch (e) {
					console.error('Ошибка выполнения:', e);
				} finally {
					runBtn.disabled = false;
					setStatus('');
				}
			}

			runBtn.addEventListener('click', run);
		})

	</script>
</body>

</html>